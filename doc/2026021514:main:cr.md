# 阶段性深度 CR 报告（2026-02-15 14:00）

## a. Commit message
- 建议提交信息（本次仅 CR 与报告）：`docs: deep CR report for recurrence/schedule architecture`

## b. Modified Files and Summary of Changes
- 当前工作区待提交改动：
  - `README.md`
  - `assistant_app/agent.py`
  - `assistant_app/db.py`
  - `tests/test_agent.py`
  - `tests/test_db.py`
- 本阶段能力增量摘要：
  - 日程重复规则改为独立表（分钟间隔 + 次数 + 启停）。
  - 重复次数支持 `-1`（无限）。
  - `/schedule list` 默认窗口改为“前天起未来 1 个月”，并限制最大查询范围 31 天。
  - CLI 日程展示补充重复相关字段（间隔/次数/启用状态）。
  - 增强了重复规则相关测试（启停、窗口、冲突、无限重复）。

## c. Reasons and Purposes of Each Modification
- `assistant_app/db.py`
  - 目的：将重复规则从“预展开写入多条日程”升级为“规则化存储 + 按需展开”，降低写放大并提高灵活性（启停、窗口化查询）。
- `assistant_app/agent.py`
  - 目的：统一命令层语义（`--interval` + `--times`），并将自然语言意图映射到统一命令执行路径，减少多分支行为差异。
- `tests/test_db.py` / `tests/test_agent.py`
  - 目的：覆盖新语义（无限重复、窗口限制、重复规则启停）并防回归。
- `README.md`
  - 目的：同步 CLI 命令与行为变更，保持“文档=运行时行为”。

## d. Potential Issues in Current Code (Findings First)

### P1（高） `/schedule view` 对无限重复日程存在“锚点不可达”问题
- 位置：`assistant_app/agent.py:385` 调用 `self.db.list_schedules()` 未传窗口；`assistant_app/db.py:616`~`assistant_app/db.py:620` 对 `repeat_times=-1` 在无窗口时强制使用 `now ~ now+31天`。
- 影响：查看远期/历史月视图时，无限重复事件不会被展开到目标锚点，导致“明明有重复规则但视图为空”。
- 复现：创建每周无限重复后执行 `/schedule view month 2026-04`，返回“month 视图下暂无日程”。
- 建议：`/schedule view` 先根据 anchor 计算窗口，再调用 `list_schedules(window_start, window_end)`，避免依赖“当前时间窗口”。

### P1（高） 无限重复冲突检测只预览前 500 次，可能漏检真实冲突
- 位置：`assistant_app/agent.py:1589`~`assistant_app/agent.py:1598`，`repeat_times=-1` 时仅生成 500 个候选时间点。
- 影响：若冲突发生在第 501 次之后，新增/更新会被误判“无冲突”。
- 复现：已有 10:00 日程；新增 00:00 开始、间隔 1 分钟的无限重复，理论上 10:00 冲突，但当前实现可成功添加。
- 建议：冲突检测改为“窗口化策略”（例如只校验未来 N 天且 N 可配置），并在文档/提示中明确冲突检测时域；或将冲突检测下沉到 DB 的区间算法，避免固定条数预览。

### P2（中） 有限重复被 `max_items=2000` 静默截断
- 位置：`assistant_app/db.py:621`~`assistant_app/db.py:628`。
- 影响：`repeat_times` 很大（如 3000）时，`list_schedules()` 只返回前 2000 条，用户无法感知截断。
- 建议：
  - 方案 A：对大次数强制要求窗口查询，不允许无窗口全量；
  - 方案 B：返回时附带 `truncated=true` 元信息并在 CLI 提示；
  - 方案 C：限制 `repeat_times` 上限并在写入时校验。

### P2（中） 用户反馈文案对无限重复不友好
- 位置：`assistant_app/agent.py:466`。
- 表现：会提示“已添加重复日程 -1 条”，语义不自然。
- 建议：对 `repeat_times=-1` 特判文案，如“已添加无限重复日程规则”。

### P3（低） 代码可读性：保留了严格 JSON 方案下的历史遗留解析函数
- 位置：`assistant_app/agent.py:1660` 之后的 `_extract_intent_label`、`_extract_args_from_text`、`_extract_todo_content`。
- 影响：与“严格只认 JSON”的当前策略不一致，增加维护者理解负担。
- 建议：删除未使用函数，或明确标注“保留用途 + 当前未启用”。

### P3（低） 类型检查边界与测试替身不一致
- 位置：`assistant_app/cli.py:17`、`assistant_app/cli.py:40` 与 `tests/test_cli.py:40`~`tests/test_cli.py:61`。
- 现象：运行 `python3 -m mypy assistant_app tests main.py` 会报 `_FakeAgent` 与 `AssistantAgent` 类型不兼容。
- 建议：将 CLI 相关函数参数改为 `Protocol`（含 `llm_client` 与 `handle_input`），提升可测试性与类型表达准确度。

## e. Unit Test Report
- 已执行：
  - `python3 -m ruff check .` -> 通过
  - `python3 -m mypy` -> 通过（按项目配置检查 `assistant_app` 与 `main.py`）
  - `python3 -m pytest -q` -> 通过（`92 passed`）
- 额外工程化检查：
  - `python3 -m mypy assistant_app tests main.py` -> 未通过（`tests/test_cli.py` 中替身类型与函数签名不匹配，见上文 P3）

## 附：近期提交历史（用于变更上下文）
- `b8be79c` feat: detect schedule conflicts by time range
- `6fd0b62` feat: add schedule duration in minutes
- `39ad8e2` feat: add schedule conflict detection
- `988980c` feat: add schedule calendar views
- `1430d4a` feat: add recurring schedule creation support
- `4e94012` feat: add todo list views and view commands
- `e5f40ed` feat: add todo search command and intent
